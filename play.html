<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Watch Now!</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .server-section {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      margin-right: 10px;
    }
    select {
      padding: 8px;
      font-size: 1em;
      background-color: #1e1e1e;
      color: white;
      border: 1px solid #444;
      border-radius: 5px;
    }
    button {
      padding: 8px 15px;
      margin-left: 10px;
      font-size: 1em;
      background-color: #ff9900;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    iframe {
      width: 100%;
      height: 80vh;
      border: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Watch Now!</h1>

  <div class="server-section">
    <div id="embed-server-section" style="margin-bottom: 10px;">
      <label for="embed-server">Embed Server:</label>
      <select id="embed-server"></select>
    </div>

    <div id="external-server-section" style="margin-bottom: 10px;">
      <label for="external-server">External Server:</label>
      <select id="external-server"></select>
      <button id="go-external">Go</button>
    </div>
  </div>

  <iframe id="video-iframe" src="" allowfullscreen sandbox="allow-scripts allow-same-origin"></iframe>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const tmdbId = urlParams.get("tmdb");
    const anilistId = urlParams.get("anime");
    const season = urlParams.get("season");
    const episode = urlParams.get("ep");

    const embedSelect = document.getElementById("embed-server");
    const externalSelect = document.getElementById("external-server");
    const iframe = document.getElementById("video-iframe");
    const externalSection = document.getElementById("external-server-section");

    const epNum = episode || 1;
    let imdbId = null;

    const tmdbEmbedServers = [
      { name: "FMovies+", url: (s) => `https://www.fmovies.cat/watch/${s}` },
      { name: "RiveStream", url: (s) => `https://rivestream.org/watch?${s}` },
      { name: "XPrime", url: (s) => `https://xprime.tv/watch/${s}` },
      { name: "SmashyStream", url: (s) => `https://player.smashy.stream/${s}` },
      { name: "AnyEmbed", url: (s) => `https://anyembed.xyz/${s}` },
      { name: "VidSrc", url: (s) => `https://vidsrc.cc/v2/embed/${s}?autoPlay=true` },
    ];

    const tmdbExternalServers = [
      { name: "P-Stream", url: (s) => `https://pstream.org/media/${s}` },
      { name: "Cineby", url: (s) => `https://www.cineby.app/${s}?play=true` },
      { name: "BitCine", url: (s) => `https://www.bitcine.app/${s}?play=true` },
      { name: "VeloraTV", url: (s) => `https://veloratv.ru/watch/${s}` },
    ];

    const animeEmbedServers = [
      { name: "Miruro", url: () => `https://www.miruro.to/watch?id=${anilistId}&ep=${epNum}` },
      { name: "Gojo", url: () => `https://animetsu.to/watch/${anilistId}?ep=${epNum}` },
      { name: "Anime Realms", url: () => `https://www.animerealms.org/watch?id=${anilistId}&ep=${epNum}` },
      { name: "Cinemaos", url: () => `https://cinemaos.live/anime/${anilistId}` },
      { name: "AniPlay", url: () => `https://aniplaynow.live/anime/watch/${anilistId}?host=pahe&ep=${epNum}&type=sub` },
      { name: "VidSrc", url: () => `https://vidsrc.cc/v2/embed/anime/ani${anilistId}/${epNum}/sub?autoPlay=true` },
    ];

    function fillEmbedDropdown(sources) {
      embedSelect.innerHTML = "";
      sources.forEach((server, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = server.name;
        embedSelect.appendChild(option);
      });
    }

    function fillExternalDropdown(sources) {
      externalSelect.innerHTML = "";
      sources.forEach((server, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = server.name;
        externalSelect.appendChild(option);
      });
    }

    function updateEmbedSrc(src) {
      iframe.src = src;
    }

    async function fetchIMDbId(type, id) {
      const res = await fetch(`/api/imdb?type=${type}&id=${id}`);
      const json = await res.json();
      return json.imdb_id || null;
    }

    async function init() {
      if (anilistId) {
        fillEmbedDropdown(animeEmbedServers);
        externalSection.style.display = "none";
        updateEmbedSrc(animeEmbedServers[0].url());
        embedSelect.addEventListener("change", () => {
          updateEmbedSrc(animeEmbedServers[embedSelect.value].url());
        });
      } else if (tmdbId) {
        const type = season && episode ? "tv" : "movie";
        imdbId = await fetchIMDbId(type, tmdbId);

        const embedPaths = {
          movie: {
            fmovies: `movie/${tmdbId}`,
            rivestream: `type=movie&id=${tmdbId}`,
            xprime: tmdbId,
            smashy: `movie/${tmdbId}`,
            anyembed: `movie/${tmdbId}`,
            vidsrc: `movie/${tmdbId}`,
          },
          tv: {
            fmovies: `tv/${tmdbId}/${season}/${episode}`,
            rivestream: `type=tv&id=${tmdbId}&season=${season}&episode=${episode}`,
            xprime: `${tmdbId}/${season}/${episode}`,
            smashy: `tv/${tmdbId}?s=${season}&e=${episode}`,
            anyembed: `tv/${tmdbId}/${season}/${episode}`,
            vidsrc: `tv/${tmdbId}/${season}/${episode}`,
          },
        };

        const externalPaths = {
          movie: [
            `tmdb-movie-${tmdbId}`,
            `movie/${tmdbId}`,
            `movie/${tmdbId}`,
            `movie/${tmdbId}`,
          ],
          tv: [
            `tmdb-tv-${tmdbId}`,
            `tv/${tmdbId}/${season}/${episode}`,
            `tv/${tmdbId}/${season}/${episode}`,
            `tv/${tmdbId}/${season}/${episode}`,
          ],
        };

        const currentEmbed = embedPaths[type];
        const currentExternal = externalPaths[type];

        fillEmbedDropdown(tmdbEmbedServers);
        fillExternalDropdown(tmdbExternalServers);
        externalSection.style.display = "block";

        // Set initial embed
        updateEmbedSrc(tmdbEmbedServers[0].url(currentEmbed.fmovies));

        embedSelect.addEventListener("change", () => {
          const pathMap = Object.values(currentEmbed);
          const src = tmdbEmbedServers[embedSelect.value].url(pathMap[embedSelect.value]);
          updateEmbedSrc(src);
        });

        document.getElementById("go-external").addEventListener("click", () => {
          const link = tmdbExternalServers[externalSelect.value].url(currentExternal[externalSelect.value]);
          window.open(link, "_blank");
        });
      } else {
        document.body.innerHTML = "<h2 style='text-align:center;'>Missing TMDB or AniList ID</h2>";
      }
    }

    init();
  </script>
</body>
</html>
